@page "/sendtax"

@inject HttpClient Http
@using SendTaxDataApp.Shared
@using SendTaxDataApp.Models
@using SendTaxDataApp.Models.Enums
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System;
@using SendTaxDataApp.Helpers;
@using System.Text.Json;

@* <EditForm Model="@model" OnValidSubmit="OnValidSubmit"> *@
 @* <DataAnnotationsValidator/> *@
 
<MudGrid>
    <MudItem xs="8" sm="5">
        <MudCard>
            <MudCardContent>
                <MudTextField Label="شماره اقتصادی خرید" HelperText="Max. 8 characters"
                              @bind-Value="model.Tinb" For="@(() => model.Tinb)"/>
                <MudTextField Label="شماره اقتصادی فروشنده" Class="mt-3"
                              @bind-Value="model.Tins" For="@(() => model.Tins)"/>
                <MudSelect T="InvoiceSubjectType"  ValueChanged="@SubjectTypeChanged" Label="موضوع صورت حساب"  AnchorOrigin="Origin.BottomCenter" >
                    @foreach (InvoiceSubjectType item in Enum.GetValues(typeof(InvoiceSubjectType))){
                                <MudSelectItem Value="@item">@item.GetDescription()</MudSelectItem>}
                </MudSelect>
                <MudSelect T="InvoicePattern"ValueChanged="@PatternChanged"  Label="الگوی صورتحساب"  AnchorOrigin="Origin.BottomCenter">
                     @foreach (InvoicePattern item in Enum.GetValues(typeof(InvoicePattern))){
                                <MudSelectItem Value="@item">@item.GetDescription()</MudSelectItem>}
                </MudSelect>
            </MudCardContent>
           
        </MudCard>
      
    </MudItem>
    <MudItem xs="8" sm="5">
        <MudCard>
            <MudCardContent>
                 <MudSelect T="PaymentType"  ValueChanged="@PaymentChanged"  Label="روش تسویه" AnchorOrigin="Origin.BottomCenter">
                 
                   @foreach (PaymentType item in Enum.GetValues(typeof(PaymentType))){
                                <MudSelectItem Value="@item">@item.GetDescription()</MudSelectItem>}
                </MudSelect>
                <MudTextField  Disabled="true"Label="مجموع مبلغ قبل از کسر تخفیف" 
                              @bind-Value="model.Tprdis" For="@(() => model.Tprdis)"/>
                <MudTextField Disabled="true" Label="مجموع تخفیفات" 
                              @bind-Value="model.Tdis" />
             
               
                </MudCardContent>
        </MudCard>
    </MudItem>
    

<MudItem xs="15" sm="20">
  <MudCard>
    <MudTable Items="invoiceItems" Hover="true" RowEditCommit="edit" SortLabel="Sort By" Elevation="0">
        <ToolBarContent>
        <MudText Typo="Typo.h6">اقلام فاکتور مالیاتی</MudText>
        <MudSpacer />
        <MudButton OnClick=@AddEmptyElement>+</MudButton>
        
    </ToolBarContent>
        <HeaderContent>
            <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<InvoiceItem, object>(x=>x.Sstid)">شناسه کالا</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Am)">تعداد</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Fee)">مبلغ واحد کالا</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Prdis!)">مبلغ قبل از تخفیف</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Dis!)">مبلغ تخفیف</MudTableSortLabel></MudTh>
             <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Adis!)">مبلغ بعد از تخفیف</MudTableSortLabel></MudTh>
             <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Vra!)">نرخ مالیات بر ارزش افزوده</MudTableSortLabel></MudTh>
             <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Vam!)">مبلغ مالیات بر ارزش افزوده</MudTableSortLabel></MudTh>
              <MudTh><MudTableSortLabel SortBy="new Func<InvoiceItem, object>(x=>x.Tsstam!)">مبلغ کل کالا/خدمت</MudTableSortLabel></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="شناسه کالا">@context.Sstid</MudTd>
            <MudTd DataLabel="تعداد">@context.Am</MudTd>
            <MudTd DataLabel="مبلغ واحد کالا">@context.Fee</MudTd>
            <MudTd DataLabel="مبلغ قبل از تخفیف">@context.Prdis</MudTd>
            <MudTd DataLabel="مبلغ تخفیف">@context.Dis</MudTd>
            <MudTd DataLabel="مبلغ بعد از تخفیف">@context.Adis</MudTd>
            <MudTd DataLabel="نرخ مالیات بر ارزش افزوده">@context.Vra</MudTd>
            <MudTd DataLabel="مبلغ مالیات بر ارزش افزوده">@context.Vam</MudTd>
            <MudTd DataLabel="مبلغ کل کالا/خدمت">@context.Tsstam</MudTd>
        </RowTemplate>
          <RowEditingTemplate>
            <MudTd DataLabel="شناسه کالا"> <MudTextField @bind-Value="@context.Sstid" Required /></MudTd>
            <MudTd DataLabel="تعداد"><MudTextField  @bind-Value="@context.Am" Required /></MudTd>
            <MudTd DataLabel="مبلغ واحد کالا"><MudTextField  @bind-Value="@context.Fee" Required /></MudTd>
            <MudTd DataLabel="مبلغ قبل از تخفیف">@context.Prdis</MudTd>
            <MudTd DataLabel="مبلغ تخفیف"><MudTextField  @bind-Value="@context.Dis" Required /></MudTd>
            <MudTd DataLabel="مبلغ بعد از تخفیف">@context.Adis </MudTd>
            <MudTd DataLabel="نرخ مالیات بر ارزش افزوده"><MudTextField  @bind-Value="@context.Vra" Required /></MudTd>
            <MudTd DataLabel="مبلغ مالیات بر ارزش افزوده">@context.Vam</MudTd>
            <MudTd DataLabel="مبلغ کل کالا/خدمت">@context.Tsstam</MudTd>
        </RowEditingTemplate>
        
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[]{50, 100}" />
        </PagerContent>
    </MudTable>
     </MudCard>
  </MudItem>
 <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" @onclick="OnValidSubmit">Register</MudButton>
            </MudCardActions>

</MudGrid> 

@code {
    bool success;
    string[] errors = { };
    MudTextField<string> pwField1;
    MudForm form;
    Invoice model=new Invoice();
   
    private List<InvoiceItem> invoiceItems;
        private void edit(object invoiceItem){
            model.Tdis=model.Tdis+((InvoiceItem)invoiceItem).Dis;
        model.Tadis=model.Tadis+((InvoiceItem)invoiceItem).Adis;
      model.Tprdis=model.Tprdis+((InvoiceItem)invoiceItem).Prdis;
        model.Tvam=model.Tvam+((InvoiceItem)invoiceItem).Vam;
        model.Tbill=model.Tbill+((InvoiceItem)invoiceItem).Tsstam;
        model.Cap=model.Tbill;
          
        string jsonString = JsonSerializer.Serialize(model);

        Console.WriteLine(jsonString);
        }
     private void AddEmptyElement()
    {
        
        invoiceItems.Add(new InvoiceItem());
    }
    protected override async Task OnInitializedAsync()
    {
       
        invoiceItems = new List<InvoiceItem>();
    }
    private void calculateAll(){
        model.Tdis=invoiceItems.Sum(d=>d.Dis);
        model.Tadis=invoiceItems.Sum(d=>d.Adis);
        model.Tprdis=invoiceItems.Sum(d=>d.Prdis);
        model.Tvam=invoiceItems.Sum(d=>d.Vam);
        model.Tbill=invoiceItems.Sum(d=>d.Tsstam);
        model.Cap=model.Tbill;
    }
    private void OnValidSubmit()
    {
        success = true;
        model.Items=invoiceItems;
      
       calculateAll();
        

    }

    public void SubjectTypeChanged(InvoiceSubjectType subjectType){
       

       model.Ins=(int)subjectType;
    }
    public void PatternChanged(InvoicePattern invoicePattern){
       
        model.Inp=(int)invoicePattern;
    }
     public void PaymentChanged(PaymentType paymentType){
       
        model.Setm=(int)paymentType;
    }
    
}
